#!/usr/bin/env bash
set -euo pipefail

echo "=== Job FFmpeg iniciado ==="

# ===============================
# 0. VARIABLES DEL JOB
# ===============================
: "${IMAGES:?Debes definir IMAGES}"
: "${AUDIOS:?Debes definir AUDIOS}"
: "${OUTPUT_BUCKET:?Debes definir OUTPUT_BUCKET}"

OUTPUT_FILENAME="${OUTPUT_FILENAME:-video_$(date +%s).mp4}"

WORKDIR="/tmp/work"
mkdir -p "$WORKDIR"
cd "$WORKDIR"

echo "=== Parámetros recibidos ==="
echo "IMAGES=$IMAGES"
echo "AUDIOS=$AUDIOS"
echo "OUTPUT_BUCKET=$OUTPUT_BUCKET"
echo "OUTPUT_FILENAME=$OUTPUT_FILENAME"
echo "Directorio: $WORKDIR"
echo "============================="

# ===============================
# 1. PARSEAR LISTAS COMA → ARRAY
# ===============================
IFS=',' read -ra IMG_ARRAY <<< "$IMAGES"
IFS=',' read -ra AUD_ARRAY <<< "$AUDIOS"

IMG_COUNT=${#IMG_ARRAY[@]}
AUD_COUNT=${#AUD_ARRAY[@]}

if [[ "$IMG_COUNT" -ne "$AUD_COUNT" ]]; then
  echo "Error: cantidad imágenes ($IMG_COUNT) ≠ audios ($AUD_COUNT)"
  exit 1
fi

TOTAL=$IMG_COUNT
echo "Total de pares: $TOTAL"

# ===============================
# 2. DESCARGAR ARCHIVOS
# ===============================
echo "Descargando imágenes y audios..."

for (( i=0; i<TOTAL; i++ )); do
  IMG_URL="${IMG_ARRAY[$i]}"
  AUD_URL="${AUD_ARRAY[$i]}"

  echo "Descargando img$i.jpg..."
  curl -L "$IMG_URL" -o "img$i.jpg"

  echo "Descargando audio$i.mp3..."
  curl -L "$AUD_URL" -o "audio$i.mp3"
done

ls -lh

# ===============================
# 3. GENERAR CLIPS (FADES SUAVES)
# ===============================
echo "Generando clips…"

for (( i=0; i<TOTAL; i++ )); do
  echo "Generando clip$i.mp4..."

  # Duración exacta del audio
  DURACION=$(ffprobe -v error -show_entries format=duration -of default=nk=1:nw=1 "audio$i.mp3")
  DURACION=$(printf "%.3f" "$DURACION")

  # Tiempos de fade (video y audio)
  FADEOUT=$(awk -v d="$DURACION" 'BEGIN { x=d-0.4; if (x<0) x=0; printf("%.3f", x) }')
  AFADEOUT=$(awk -v d="$DURACION" 'BEGIN { x=d-0.3; if (x<0) x=0; printf("%.3f", x) }')

  echo "Duración=$DURACION | FadeOutV=$FADEOUT | FadeOutA=$AFADEOUT"

  ffmpeg -y \
    -loop 1 -i "img$i.jpg" \
    -i "audio$i.mp3" \
    -filter_complex "[0:v]scale=1080:1920:force_original_aspect_ratio=increase,crop=1080:1920,format=yuv420p,fade=t=in:st=0:d=0.4,fade=t=out:st=${FADEOUT}:d=0.4[v];[1:a]afade=t=in:st=0:d=0.3,afade=t=out:st=${AFADEOUT}:d=0.3[a]" \
    -t "$DURACION" \
    -map "[v]" -map "[a]" \
    -c:v libx264 -preset medium -tune stillimage \
    -c:a aac \
    "clip$i.mp4"
done

# ===============================
# 4. CONCATENAR TODOS LOS CLIPS
# ===============================
echo "Concatenando…"

LIST="list.txt"
> "$LIST"

for (( i=0; i<TOTAL; i++ )); do
  echo "file 'clip$i.mp4'" >> "$LIST"
done

ffmpeg -y -f concat -safe 0 -i "$LIST" -c copy "final.mp4"

echo "Final generado:"
ls -lh final.mp4

# ===============================
# 5. SUBIR A GOOGLE CLOUD STORAGE
# ===============================
echo "Subiendo a GCS…"

OUTPUT_BUCKET_NORM="${OUTPUT_BUCKET%/}/"

gsutil cp "final.mp4" "${OUTPUT_BUCKET_NORM}${OUTPUT_FILENAME}"

BUCKET_PATH="${OUTPUT_BUCKET_NORM#gs://}"
BUCKET_NAME="${BUCKET_PATH%%/*}"
OBJECT_PREFIX="${BUCKET_PATH#*/}"

[[ "$OBJECT_PREFIX" == "$BUCKET_NAME" ]] && OBJECT_PREFIX=""
[[ -n "$OBJECT_PREFIX" && "${OBJECT_PREFIX: -1}" != "/" ]] && OBJECT_PREFIX="${OBJECT_PREFIX}/"

PUBLIC_URL="https://storage.googleapis.com/${BUCKET_NAME}/${OBJECT_PREFIX}${OUTPUT_FILENAME}"

echo "VIDEO_URL=$PUBLIC_URL"
echo "$PUBLIC_URL"

echo "=== Job FFmpeg finalizado correctamente ==="
